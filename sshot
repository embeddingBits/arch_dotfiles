#!/usr/bin/env bash
# screenshot.sh - Wayland screenshot tool using grim + slurp
# Dependencies: grim, slurp, wl-copy, jq (optional but recommended), xdg-user-dirs (optional)

set -euo pipefail

# Directory and filename format
SCREENSHOT_DIR="${HOME}/Pictures/Screenshots"
mkdir -p "$SCREENSHOT_DIR"

# Format: sshot_DD-MM-YYYY_HH-MM-SS.png
DATE=$(date +"%d-%m-%Y_%H-%M-%S")
FILENAME="sshot_${DATE}.png"
FULLPATH="${SCREENSHOT_DIR}/${FILENAME}"

# -----------------------------
#          FUNCTIONS
# -----------------------------

show_help() {
    echo "Usage: $(basename "$0") [OPTION]"
    echo
    echo "Options:"
    echo "  -f, --full          Capture entire screen"
    echo "  -s, --select        Interactive region selection (default)"
    echo "  -h, --help          Show this help message"
    echo
    echo "Without arguments: interactive selection (same as -s)"
    echo
    exit 0
}

take_screenshot() {
    local geometry="$1"

    if [ -z "$geometry" ]; then
        # Fullscreen
        grim "$FULLPATH"
    else
        # Region
        grim -g "$geometry" "$FULLPATH"
    fi

    # Put in clipboard
    wl-copy < "$FULLPATH"

    # Optional: nice notification (requires libnotify / notify-send)
    if command -v notify-send >/dev/null; then
        notify-send "Screenshot saved" \
            "${FULLPATH}\nCopied to clipboard" \
            -i "${FULLPATH}" \
            -t 4000
    fi

    echo "Screenshot saved to: $FULLPATH"
    echo "Copied to clipboard"
}

# -----------------------------
#           MAIN
# -----------------------------

case "${1:-}" in
    -f|--full)
        take_screenshot ""
        ;;

    -s|--select|"")
        # Interactive selection with slurp
        geometry=$(slurp -d 2>/dev/null) || exit 1
        # If user cancelled slurp (Esc/right-click) -> exit silently
        [ -z "$geometry" ] && exit 0

        take_screenshot "$geometry"
        ;;

    -h|--help)
        show_help
        ;;

    *)
        echo "Unknown option: $1" >&2
        echo "Use --help for usage information" >&2
        exit 1
        ;;
esac
